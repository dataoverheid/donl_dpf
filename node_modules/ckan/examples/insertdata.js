// This example shows how to push CSV data into CKAN DataStore automatically
// creating the Dataset and Resource for it along the way
var csv = require('csv')
  , ckan = require('../ckan')
  , Q = require('q')
  ;

// Your CKAN instance location
var endpoint = 'http://localhost:5000';
// Your API Key
var apiKey = 'tester';


var client = new ckan.Client(endpoint, apiKey);

var datasetInfo = {
  name: 'ckan-explorer',
  title: 'CKAN Explorer Data',
  resources: [{
    name: 'resource-1',
    url: 'http://ckan.org/',
    url_type: 'datastore'
  }]
};

function createDataset(cb) {
  client.action('dataset_show', { id: datasetInfo.name }, function(err, out) {
    // dataset exists
    if (!err) {
      resourceId = out.result.resources[0].id;
      // client.action('dataset_update', datasetInfo, cb);
      cb();
    } else {
      client.action('dataset_create', datasetInfo, function(err, out) {
        resourceId = out.result.resources[0].id;
        cb(err, out);
      });
    }
  });
}

function uploadData(resoureId, cb) {
  csv()
    .from('sandbox/annual.csv', {columns: true})
    .to.array(function(data, count) {
      client.action('datastore_create', {
          resource_id: resourceId,
          records: data
        },
        cb)
      })
      ;
}

if (require.main === module) {
  function report(err, out) {
    if (err) {
      console.log(err);
      console.log(err.error);
    } else {
      console.log(out);
    }
  }

  Q.nfcall(createDataset)
    .then(function() { return Q.nfcall(uploadData, resourceId)})
    .fail(report)
    .done(report)
    ;
}

